<html>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <head>
        <title>LeaderBoard | Get To Know You Games</title>
        <link rel="icon" href="/favicon.jpg">

        <link rel="stylesheet" href="/index.css">
        <script src="/index.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">

    </head>
    <body>
        <header>
            <a href="index.html">Get To Know You Games</a>
        </header>
        <h2 class="roundNumber">Round <span id="roundNumber">1</span> Results</h2>
        <h1 class="question" id="word">
            Word
        </h1>
        <div class="participantLobby" id="participantLobby">
            <div class="centerbox">
                <div class="waitingRoomContainer">
                    <div class="waitingRoomList">
                        <img id="boysCrown" src="/crown.png" style="max-width: 20px;">
                        Boys:
                        <ul id="boysList"></ul>
                    </div>
                    <div class="waitingRoomList">
                        <img id="girlsCrown" src="/crown.png" style="max-width: 20px;">
                        Girls:
                        <ul id="girlsList"></ul>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="roundNumber">LeaderBoard</h2>
        <div class="leaderboard">
            <div class="leader">1st Player One</div>
            <div class="leader">2nd Player Two</div>
            <div class="leader">3rd Player Three</div>

            <div class="button" id="nextRoundButton" onclick="nextRound()">Next Round</div>
            <a href="index.html" id="playAgain"><div class="button">Play Again</div></a>
            <div id="waitingForHost">Waiting for host to start the next round...</div>
        </div>

    </body>

    <script>
        boysList = [];
        girlsList = [];
        players = [];

        var gameCode = sessionStorage.getItem("gameCode");
        var currentPlayerName = sessionStorage.getItem("playerName");
        var isHost = sessionStorage.getItem("isHost");
        if (isHost == "false")
        {
            document.getElementById('nextRoundButton').style.display = "none";
            document.getElementById('waitingForHost').style.display = "block";
        }

        var roundNumber = sessionStorage.getItem("roundNumber");
        if (roundNumber == null)
        {
            roundNumber = 1
        }

        document.getElementById("roundNumber").innerHTML = roundNumber;

        var words = sessionStorage.getItem("words").split(",");
        word = words[(roundNumber-1)]
        document.getElementById("word").innerHTML = word;

        getPlayers(gameCode);

        if (roundNumber < 5)
        {
            do {
                getNextRound(gameCode);
                setInterval(getNextRound, 2000, gameCode);
            } while (waitingFor.length > 0);
        }
        else if (isHost == "true")
        {
            document.getElementById('nextRoundButton').style.display = "none";
            document.getElementById('playAgain').style.display = "block";
        }

        async function getPlayers(gameCode, url = 'https://hjs0sxm035.execute-api.us-east-1.amazonaws.com/default/getPlayers') {

            postData = {"gameCode": gameCode}

            const response = await fetch(url, {
            method: 'post', 
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success');
                console.log(data);

                var boysUl = document.getElementById("boysList");
                var girlsUl = document.getElementById("girlsList");
                boysUl.innerHTML = "";
                girlsUl.innerHTML = "";

                for (i = 0; i < data['Count']; i++)
                {
                    playerName = data['Items'][i]['playerName']['S'];
                    players.push(playerName);
                    lastAnswer = data['Items'][i]['lastAnswer']['S'];

                    if (lastAnswer == 'B')
                    {
                        boysList.push(playerName);

                        var li2 = document.createElement("li");
                        li2.appendChild(document.createTextNode(playerName));
                        boysUl.appendChild(li2);
                    }
                    else if (lastAnswer == 'G')
                    {
                        girlsList.push(playerName);

                        var li2 = document.createElement("li");
                        li2.appendChild(document.createTextNode(playerName));
                        girlsUl.appendChild(li2);
                    }
                }

                if (boysList.length > girlsList.length)
                {
                    document.getElementById('boysCrown').style.display = 'inline-block';
                }
                else if (girlsList.length > boysList.length)
                {
                    document.getElementById('girlsCrown').style.display = 'inline-block';
                }
                
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }


        async function nextRound(url = 'https://hjs0sxm035.execute-api.us-east-1.amazonaws.com/default/submitAnswer') {
    
            var gameCode = sessionStorage.getItem("gameCode");

            for (i in players) 
            {
                postData = {"gameCode": gameCode, "playerName": players[i], "answer":""}

                const response = await fetch(url, {
                method: 'post', 
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success');
                    sessionStorage.setItem("lastAnswer", ""); 
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }

            //how do I send everyone back to the game screen?... check if lastAnswer == "" then increment roundNumber and go to gameScreen
            
        }


        async function getNextRound(gameCode, url = 'https://hjs0sxm035.execute-api.us-east-1.amazonaws.com/default/getPlayers') {
            postData = {"gameCode": gameCode}

            const response = await fetch(url, {
            method: 'post', 
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success');
                console.log(data);

                for (i = 0; i < data['Count']; i++)
                {
                    playerName = data['Items'][i]['playerName']['S'];
                    if (currentPlayerName == playerName)
                    {
                        lastAnswer = data['Items'][i]['lastAnswer']['S'];
                        if (lastAnswer == "")
                        {
                            sessionStorage.setItem("roundNumber", (parseInt(roundNumber) + 1)); 
                            window.location.href = "game.html";
                        }
                    }
                }
                
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

    </script>
</html>